<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>数据包解析与编辑器 (Clean Version)</title>
  <style>
    :root { color-scheme: dark; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #050607;
      color: #f5f5f5;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px 0;
    }
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 16px;
      gap: 12px;
    }
    .status-pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #222;
    }
    .status-pill.ok { color: #4ade80; }
    .status-pill.err { color: #f97373; }

    .row-two {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    .card {
      background: #111827;
      border-radius: 12px;
      padding: 12px 14px 14px;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }
    .card h2 {
      font-size: 15px;
      margin: 0 0 8px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .card h3 {
      font-size: 13px;
      margin: 10px 0 4px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .section-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .field label {
      font-size: 11px;
      color: #9ca3af;
    }
    .field input,
    .field select,
    .field textarea {
      background: #020617;
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 5px 8px;
      font-size: 12px;
      color: #e5e7eb;
      outline: none;
    }
    .field textarea {
      min-height: 70px;
      resize: vertical;
      font-family: Consolas, monospace;
    }
    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59,130,246,0.5);
    }
    .field input[readonly],
    .field textarea[readonly],
    .field input[disabled],
    .field textarea[disabled] {
      opacity: 0.9;
      cursor: default;
      background: #020617;
      border-color: #1f2937;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      padding: 0 6px;
      border-radius: 999px;
      font-size: 10px;
      background: #1f2937;
      color: #9ca3af;
      gap: 4px;
    }
    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }
    .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 10px;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #1f2937;
      color: #e5e7eb;
    }
    button.primary { background: #2563eb; }
    button.primary:hover { background: #1d4ed8; }
    button:hover { filter: brightness(1.1); }
    button:disabled { opacity: .4; cursor: default; }

    .mini-btn {
      padding: 2px 8px;
      font-size: 10px;
      border-radius: 999px;
      background: #1f2937;
      color: #9ca3af;
    }
    .mini-btn:hover { filter: brightness(1.2); }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    thead { background: #030712; }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #111827;
      text-align: left;
    }
    tbody tr:nth-child(even) { background: #020617; }

    .log {
      margin-top: 10px;
      font-size: 11px;
      white-space: pre-wrap;
      background: #020617;
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 8px;
      max-height: 180px;
      overflow-y: auto;
    }
    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .pill {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #111827;
      color: #9ca3af;
    }
    .layout-bottom {
      margin-top: 8px;
    }
    @media (max-width: 960px) {
      .row-two { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <h1>PX4 数据包解析与编辑器 (MITM)</h1>
  <div class="status-bar">
    <div>
      <span id="ws-status" class="status-pill">WebSocket: 连接中...</span>
      <span id="packet-count" class="status-pill">已接收数据包: 0</span>
      <span id="old-packet-count" class="status-pill">连续旧包: 0</span>
    </div>
    <div>
      <span class="pill">最后更新：<span id="packet-ts">-</span></span>
    </div>
  </div>

  <h2 style="font-size:14px;margin:0 0 6px 2px;color:#9ca3af;">传统数据包视图</h2>
  <div id="traditional-section">
    <div class="row-two">
      <div class="card">
        <h2>
          传统数据包 - 原始（只读）
          <span class="tag"><span class="tag-dot"></span> 后端解析结果</span>
        </h2>

        <h3>链路层（Ethernet）</h3>
        <div class="section-grid">
          <div class="field">
            <label for="orig-t-eth-src">源 MAC（只读）</label>
            <input id="orig-t-eth-src" readonly disabled />
          </div>
          <div class="field">
            <label for="orig-t-eth-dst">目的 MAC（只读）</label>
            <input id="orig-t-eth-dst" readonly disabled />
          </div>
          <div class="field">
            <label for="orig-t-eth-type">以太网类型 (0x..)（只读）</label>
            <input id="orig-t-eth-type" readonly disabled />
          </div>
        </div>

        <h3>网络层（IP）</h3>
        <div class="section-grid">
          <div class="field">
            <label for="orig-t-ip-src">源 IP（只读）</label>
            <input id="orig-t-ip-src" readonly disabled />
          </div>
          <div class="field">
            <label for="orig-t-ip-dst">目的 IP（只读）</label>
            <input id="orig-t-ip-dst" readonly disabled />
          </div>
          <div class="field">
            <label for="orig-t-ip-proto">协议号（只读）</label>
            <input id="orig-t-ip-proto" readonly disabled />
          </div>
        </div>

        <h3>传输层（TCP / UDP）</h3>
        <div class="section-grid">
          <div class="field">
            <label for="orig-t-l4-type">协议（只读）</label>
            <input id="orig-t-l4-type" readonly disabled />
          </div>
          <div class="field">
            <label for="orig-t-l4-sport">源端口（只读）</label>
            <input id="orig-t-l4-sport" readonly disabled />
          </div>
          <div class="field">
            <label for="orig-t-l4-dport">目的端口（只读）</label>
            <input id="orig-t-l4-dport" readonly disabled />
          </div>
        </div>

        <h3>应用层载荷</h3>
        <div class="field">
          <label for="orig-t-payload-hex">载荷 HEX（只读）</label>
          <textarea id="orig-t-payload-hex" readonly disabled></textarea>
        </div>
        <div class="field">
          <label for="orig-t-payload-text">载荷文本（UTF-8，只读）</label>
          <textarea id="orig-t-payload-text" readonly disabled></textarea>
        </div>
      </div>

      <div class="card">
        <h2>
          传统数据包 - 编辑（可篡改）
          <span class="tag"><span class="tag-dot"></span> 可修改</span>
        </h2>

        <h3>
          链路层（Ethernet）
          <button id="btn-t-copy-eth" class="mini-btn" type="button">拷贝链路层</button>
        </h3>
        <div class="section-grid">
          <div class="field">
            <label for="t-eth-src">源 MAC</label>
            <input id="t-eth-src" />
          </div>
          <div class="field">
            <label for="t-eth-dst">目的 MAC</label>
            <input id="t-eth-dst" />
          </div>
          <div class="field">
            <label for="t-eth-type">以太网类型 (0x..)</label>
            <input id="t-eth-type" />
          </div>
        </div>

        <h3>
          网络层（IP）
          <button id="btn-t-copy-ip" class="mini-btn" type="button">拷贝网络层</button>
        </h3>
        <div class="section-grid">
          <div class="field">
            <label for="t-ip-src">源 IP</label>
            <input id="t-ip-src" />
          </div>
          <div class="field">
            <label for="t-ip-dst">目的 IP</label>
            <input id="t-ip-dst" />
          </div>
          <div class="field">
            <label for="t-ip-proto">协议号</label>
            <input id="t-ip-proto" />
          </div>
        </div>

        <h3>
          传输层（TCP / UDP）
          <button id="btn-t-copy-l4" class="mini-btn" type="button">拷贝传输层</button>
        </h3>
        <div class="section-grid">
          <div class="field">
            <label for="t-l4-type">协议</label>
            <select id="t-l4-type">
              <option value="auto">自动（按解析结果）</option>
              <option value="TCP">TCP</option>
              <option value="UDP">UDP</option>
            </select>
          </div>
          <div class="field">
            <label for="t-l4-sport">源端口</label>
            <input id="t-l4-sport" />
          </div>
          <div class="field">
            <label for="t-l4-dport">目的端口</label>
            <input id="t-l4-dport" />
          </div>
        </div>

        <h3>
          应用层载荷
          <button id="btn-t-copy-payload" class="mini-btn" type="button">拷贝载荷</button>
        </h3>
        <div class="field">
          <label for="t-payload-hex">编辑载荷 HEX</label>
          <textarea id="t-payload-hex"></textarea>
        </div>
        <div class="field">
          <label for="t-payload-text">编辑载荷文本（UTF-8）</label>
          <textarea id="t-payload-text"></textarea>
        </div>

        <h3>发送配置</h3>
        <div class="section-grid">
          <div class="field">
            <label for="t-target-ip">目标 IP</label>
            <input id="t-target-ip" placeholder="例如：192.168.1.100" />
          </div>
          <div class="field">
            <label for="t-packet-id">数据包 ID</label>
            <input id="t-packet-id" placeholder="ID" />
          </div>
        </div>

        <div class="actions">
          <button id="btn-t-copy-all" type="button">拷贝全部</button>
          <button id="btn-t-send" class="primary" type="button">重新发送</button>
        </div>
      </div>
    </div>
  </div>

  <h2 style="font-size:14px;margin:8px 0 6px 2px;color:#9ca3af;">MAVLink 数据包视图</h2>
  <div id="mavlink-section">
    <div class="row-two">
      <div class="card">
        <h2>
          MAVLink 数据包 - 原始（只读）
          <span class="tag"><span class="tag-dot"></span> 后端 Filter 增强版</span>
        </h2>

        <h3>链路层（Ethernet）</h3>
        <div class="section-grid">
          <div class="field">
            <label for="orig-mav-eth-src">源 MAC（只读）</label>
            <input id="orig-mav-eth-src" readonly disabled />
          </div>
          <div class="field">
            <label for="orig-mav-eth-dst">目的 MAC（只读）</label>
            <input id="orig-mav-eth-dst" readonly disabled />
          </div>
          <div class="field">
            <label for="orig-mav-eth-type">以太网类型 (0x..)（只读）</label>
            <input id="orig-mav-eth-type" readonly disabled />
          </div>
        </div>

        <h3>网络层（UDP）</h3>
        <div class="section-grid">
          <div class="field">
            <label for="orig-mav-ip-src">源 IP</label>
            <input id="orig-mav-ip-src" readonly disabled />
          </div>
          <div class="field">
            <label for="orig-mav-udp-sport">源端口</label>
            <input id="orig-mav-udp-sport" readonly disabled />
          </div>
          <div class="field">
            <label for="orig-mav-udp-proto">协议</label>
            <input id="orig-mav-udp-proto" readonly disabled />
          </div>
        </div>

        <h3>
          当前 MAVLink 消息
          <select id="mav-msg-select" style="font-size:11px;padding:2px 4px;border-radius:6px;background:#020617;border:1px solid #1f2937;color:#e5e7eb;">
            <option value="0">Default</option>
          </select>
        </h3>
        <div class="section-grid">
          <div class="field">
            <label for="orig-mav-msg-name">消息名 (含去重状态)</label>
            <input id="orig-mav-msg-name" readonly disabled />
          </div>
          <div class="field">
            <label for="orig-mav-msg-id">消息 ID</label>
            <input id="orig-mav-msg-id" readonly disabled />
          </div>
        </div>
        
        <h3>关键字段（优先显示后端提取的 META）</h3>
        <div class="section-grid">
          
          <div class="field">
            <label for="orig-mav-edit-x">x</label>
            <input id="orig-mav-edit-x" readonly disabled style="color: #4ade80;" />
          </div>
          <div class="field">
            <label for="orig-mav-edit-y">y</label>
            <input id="orig-mav-edit-y" readonly disabled style="color: #4ade80;" />
          </div>
          <div class="field">
            <label for="orig-mav-edit-z">z</label>
            <input id="orig-mav-edit-z" readonly disabled style="color: #4ade80;" />
          </div>
          <div class="field">
            <label for="orig-mav-edit-vx">vx</label>
            <input id="orig-mav-edit-vx" readonly disabled />
          </div>
          <div class="field">
            <label for="orig-mav-edit-vy">vy</label>
            <input id="orig-mav-edit-vy" readonly disabled />
          </div>
          <div class="field">
            <label for="orig-mav-edit-vz">vz</label>
            <input id="orig-mav-edit-vz" readonly disabled />
          </div>
        </div>

        <h3>原始 HEX</h3>
        <div class="field">
          <label for="orig-mav-raw-hex">MAVLink 帧 HEX（只读）</label>
          <textarea id="orig-mav-raw-hex" readonly disabled></textarea>
        </div>

        <h3>字段明细（JSON）</h3>
        <div class="field">
          <label for="orig-mav-fields">当前消息字段</label>
          <textarea id="orig-mav-fields" readonly disabled style="min-height:120px;"></textarea>
        </div>
      </div>

      <div class="card">
        <h2>
          MAVLink 数据包 - 编辑
          <span class="tag"><span class="tag-dot"></span> 可修改</span>
        </h2>

        <h3>链路层（Ethernet）</h3>
        <div class="section-grid">
          <div class="field">
            <label for="mav-eth-src">源 MAC</label>
            <input id="mav-eth-src" />
          </div>
          <div class="field">
            <label for="mav-eth-dst">目的 MAC</label>
            <input id="mav-eth-dst" readonly disabled />
          </div>
          <div class="field">
            <label for="mav-eth-type">以太网类型 (0x..)</label>
            <input id="mav-eth-type" readonly disabled />
          </div>
        </div>

        <h3>网络层（UDP）</h3>
        <div class="section-grid">
          <div class="field">
            <label for="edit-mav-ip-src">源 IP</label>
            <input id="edit-mav-ip-src" placeholder="默认同左" />
          </div>
          <div class="field">
            <label for="edit-mav-udp-sport">源端口</label>
            <input id="edit-mav-udp-sport" placeholder="默认同左" />
          </div>
          <div class="field">
            <label for="edit-mav-udp-proto">协议</label>
            <input id="edit-mav-udp-proto" placeholder="UDP" />
          </div>
        </div>

        <h3>当前 MAVLink 消息</h3>
        <div class="section-grid">
          <div class="field">
            <label for="mav-edit-msg-name">消息名</label>
            <input id="mav-edit-msg-name" />
          </div>
          <div class="field">
            <label for="mav-edit-msg-id">消息 ID</label>
            <input id="mav-edit-msg-id" />
          </div>
        </div>

        <h3>关键字段编辑（位置 / 速度）</h3>
        <div class="section-grid">
          <div class="field">
            <label for="mav-edit-x">x</label>
            <input id="mav-edit-x" />
          </div>
          <div class="field">
            <label for="mav-edit-y">y</label>
            <input id="mav-edit-y" />
          </div>
          <div class="field">
            <label for="mav-edit-z">z</label>
            <input id="mav-edit-z" />
          </div>
          <div class="field">
            <label for="mav-edit-vx">vx</label>
            <input id="mav-edit-vx" />
          </div>
          <div class="field">
            <label for="mav-edit-vy">vy</label>
            <input id="mav-edit-vy" />
          </div>
          <div class="field">
            <label for="mav-edit-vz">vz</label>
            <input id="mav-edit-vz" />
          </div>
        </div>

        <h3>原始 HEX（可编辑）</h3>
        <div class="field">
          <label for="mav-payload-hex">MAVLink 帧 HEX</label>
          <textarea id="mav-payload-hex"></textarea>
        </div>

        <h3>字段明细（JSON，可编辑）</h3>
        <div class="field">
          <label for="mav-edit-fields">当前消息字段</label>
          <textarea id="mav-edit-fields" style="min-height:120px;"></textarea>
        </div>

        <div class="actions">
          <button id="btn-mav-copy-all" type="button">同步左侧数据</button>
          <button id="btn-mav-send" class="primary" type="button">发送修改数据</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card layout-bottom">
    <h2>最近数据包概览 & 日志</h2>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>时间</th>
          <th>类型</th>
          <th>来源</th>
          <th>备注</th>
        </tr>
      </thead>
      <tbody id="packet-table-body">
        </tbody>
    </table>

    <div class="log">
      <div class="log-header">
        <span>日志</span>
        <button id="btn-clear-log" style="font-size:10px;padding:2px 8px;">清空日志</button>
      </div>
      <div id="log-body"></div>
    </div>
  </div>

  <script>
    // ========== 状态 ==========
    let ws;
    let packetCounter = 0;
    let oldPacketCounter = 0;

    const wsStatusEl      = document.getElementById("ws-status");
    const packetCountEl   = document.getElementById("packet-count");
    const oldPacketCountEl = document.getElementById("old-packet-count");
    const packetTsEl      = document.getElementById("packet-ts");
    const packetTableBody = document.getElementById("packet-table-body");
    const logBody         = document.getElementById("log-body");

    const traditionalSection = document.getElementById("traditional-section");
    const mavlinkSection     = document.getElementById("mavlink-section");

    // -------- 传统数据包：左边只读区域 --------
    const origTEthSrcInput  = document.getElementById("orig-t-eth-src");
    const origTEthDstInput  = document.getElementById("orig-t-eth-dst");
    const origTEthTypeInput = document.getElementById("orig-t-eth-type");

    const origTIpSrcInput   = document.getElementById("orig-t-ip-src");
    const origTIpDstInput   = document.getElementById("orig-t-ip-dst");
    const origTIpProtoInput = document.getElementById("orig-t-ip-proto");

    const origTL4TypeInput  = document.getElementById("orig-t-l4-type");
    const origTL4SportInput = document.getElementById("orig-t-l4-sport");
    const origTL4DportInput = document.getElementById("orig-t-l4-dport");

    const origTPayloadHexTextarea  = document.getElementById("orig-t-payload-hex");
    const origTPayloadTextTextarea = document.getElementById("orig-t-payload-text");

    // -------- MAVLink 区域 DOM 元素 --------
    // 左侧只读
    const orig_mav_eth_src = document.getElementById('orig-mav-eth-src');
    const orig_mav_eth_dst = document.getElementById('orig-mav-eth-dst');
    const orig_mav_eth_type = document.getElementById('orig-mav-eth-type');
    const orig_mav_ip_src = document.getElementById('orig-mav-ip-src');
    const orig_mav_udp_sport = document.getElementById('orig-mav-udp-sport');
    const orig_mav_udp_proto = document.getElementById('orig-mav-udp-proto');
    
    // 移除的 DOM 引用：
    // orig_mav_proto, orig_mav_msg_count, orig_mav_sysid, orig_mav_compid, orig_mav_seq
    
    const orig_mav_msg_name = document.getElementById('orig-mav-msg-name');
    const orig_mav_msg_id = document.getElementById('orig-mav-msg-id');

    const orig_mav_edit_x = document.getElementById('orig-mav-edit-x');
    const orig_mav_edit_y = document.getElementById('orig-mav-edit-y');
    const orig_mav_edit_z = document.getElementById('orig-mav-edit-z');
    const orig_mav_edit_vx = document.getElementById('orig-mav-edit-vx');
    const orig_mav_edit_vy = document.getElementById('orig-mav-edit-vy');
    const orig_mav_edit_vz = document.getElementById('orig-mav-edit-vz');
    const orig_mav_raw_hex = document.getElementById('orig-mav-raw-hex');
    const orig_mav_fields = document.getElementById('orig-mav-fields');

    // 右侧编辑 (部分)
    const mav_eth_src = document.getElementById('mav-eth-src');
    const mav_eth_dst = document.getElementById('mav-eth-dst');
    const mav_eth_type = document.getElementById('mav-eth-type');
    const edit_mav_ip_src = document.getElementById('edit-mav-ip-src');
    const edit_mav_udp_sport = document.getElementById('edit-mav-udp-sport');
    const edit_mav_udp_proto = document.getElementById('edit-mav-udp-proto');
    const mav_edit_x = document.getElementById('mav-edit-x');
    const mav_edit_y = document.getElementById('mav-edit-y');
    const mav_edit_z = document.getElementById('mav-edit-z');
    const mav_edit_vx = document.getElementById('mav-edit-vx');
    const mav_edit_vy = document.getElementById('mav-edit-vy');
    const mav_edit_vz = document.getElementById('mav-edit-vz');
    const mav_payload_hex = document.getElementById('mav-payload-hex');
    const mav_edit_fields = document.getElementById('mav-edit-fields');
    const editMsgName = document.getElementById('mav-edit-msg-name');
    const editMsgId = document.getElementById('mav-edit-msg-id');

    // -------- 一些小工具函数 --------
    function appendLog(text) {
      const time = new Date().toISOString().split("T")[1].split(".")[0];
      const line = document.createElement("div");
      line.textContent = `[${time}] ${text}`;
      line.style.borderBottom = "1px solid #333";
      logBody.appendChild(line);
      logBody.parentElement.scrollTop = logBody.parentElement.scrollHeight;
    }

    function setWsStatus(text, ok = false) {
      wsStatusEl.textContent = text;
      wsStatusEl.classList.toggle("ok", ok);
      wsStatusEl.classList.toggle("err", !ok);
    }

    function updatePacketCount() {
      packetCountEl.textContent = `已接收数据包: ${packetCounter}`;
    }

    function updateOldPacketCount() {
      oldPacketCountEl.textContent = `连续旧包: ${oldPacketCounter}`;
    }

    function updateTimestampNow() {
      const d = new Date();
      packetTsEl.textContent = d.toLocaleTimeString();
    }

    function hexToText(hex) {
      if (!hex) return "";
      const clean = hex.replace(/\s+/g, "");
      if (clean.length % 2 !== 0) return "";
      const bytes = [];
      for (let i = 0; i < clean.length; i += 2) {
        const b = parseInt(clean.slice(i, i + 2), 16);
        if (Number.isNaN(b)) return "";
        bytes.push(b);
      }
      try {
        return new TextDecoder("utf-8").decode(new Uint8Array(bytes));
      } catch {
        return "";
      }
    }

    function addPacketRowSimple(packet, appProto) {
      const tr = document.createElement("tr");
      const ts = new Date();
      const tsStr = ts.toLocaleTimeString();

      const src = packet.network
        ? `${packet.network.src_ip || ""}:${packet.network.src_port || ""}`
        : "";

      const cols = [
        ++packetCounter,
        tsStr,
        appProto === "MAVLink" ? "MAVLink" : "传统",
        src,
        appProto || ""
      ];

      cols.forEach(v => {
        const td = document.createElement("td");
        td.textContent = v;
        tr.appendChild(td);
      });

      // 限制表格行数，防止浏览器卡顿
      if (packetTableBody.children.length > 50) {
        packetTableBody.removeChild(packetTableBody.lastChild);
      }
      packetTableBody.insertBefore(tr, packetTableBody.firstChild);
      updatePacketCount();
    }

    // ========== 核心：根据 JSON 填充传统数据包区域 ==========

    function fillTraditionalFromPacket(packet) {
      const link = packet.link || {};
      const net  = packet.network || {};
      const app  = packet.application || {};

      // 链路层
      origTEthSrcInput.value  = link.src_mac || "";
      origTEthDstInput.value  = link.dst_mac || "";
      origTEthTypeInput.value = link.eth_type || "";

      // 网络层
      origTIpSrcInput.value   = net.src_ip || "";
      origTIpDstInput.value   = net.dst_ip || "";
      origTIpProtoInput.value = net.protocol || "";

      // 传输层
      origTL4TypeInput.value  = net.protocol || "";
      origTL4SportInput.value = net.src_port != null ? String(net.src_port) : "";
      origTL4DportInput.value = net.dst_port != null ? String(net.dst_port) : "";

      // 应用层载荷
      const payloadHex = app.raw_hex || app.hex || "";
      origTPayloadHexTextarea.value  = payloadHex;
      origTPayloadTextTextarea.value = hexToText(payloadHex);
    }

    // 显示哪个区域
    function showTraditionalView() {
      traditionalSection.style.display = "block";
      mavlinkSection.style.display     = "none";
    }

    // ========== 关键修改：适配后端 META 逻辑 ==========
    function showMavlinkView(packet) {
      traditionalSection.style.display = "none";
      mavlinkSection.style.display     = "block";
      
      const link = packet.link || {};
      const net  = packet.network || {};
      const app  = packet.application || {};
      const meta = packet.meta || {};
      const fields = app.fields || {};
      const payload = fields.payload || {};
      const msgNameRaw = app.kind || "Unknown";
      const msgIdRaw = (packet.id !== undefined ? packet.id : (app.id !== undefined ? app.id : app.msg_id));
      const msgIdStr = (msgIdRaw !== undefined && msgIdRaw !== null) ? String(msgIdRaw) : "";

      // 1. 基础网络信息填充
      if (orig_mav_eth_src) orig_mav_eth_src.value = link.src_mac || "";
      if (orig_mav_eth_dst) orig_mav_eth_dst.value = link.dst_mac || "";
      if (orig_mav_eth_type) orig_mav_eth_type.value = link.eth_type || "";
      if (mav_eth_src) mav_eth_src.value = orig_mav_eth_src?.value || link.src_mac || "";
      if (mav_eth_dst) mav_eth_dst.value = orig_mav_eth_dst?.value || link.dst_mac || "";
      if (mav_eth_type) mav_eth_type.value = orig_mav_eth_type?.value || link.eth_type || "";
      
      if (orig_mav_ip_src) orig_mav_ip_src.value = net.src_ip || "";
      if (orig_mav_udp_sport) orig_mav_udp_sport.value = net.src_port || "";
      if (orig_mav_udp_proto) orig_mav_udp_proto.value = net.protocol || "";
      if (edit_mav_ip_src) edit_mav_ip_src.value = orig_mav_ip_src?.value || net.src_ip || "";
      if (edit_mav_udp_sport) edit_mav_udp_sport.value = orig_mav_udp_sport?.value || net.src_port || "";
      if (edit_mav_udp_proto) edit_mav_udp_proto.value = orig_mav_udp_proto?.value || net.protocol || "";

      // 2. MAVLink 协议信息 (DOM 已删除，不再填充)

      // 3. 消息名称与去重统计
      let msgDisplayName = msgNameRaw;
      if (meta.repeat_since_last !== undefined && meta.repeat_since_last > 0) {
        msgDisplayName += ` (跳过 ${meta.repeat_since_last} 次重复)`;
      }
      if (orig_mav_msg_name) orig_mav_msg_name.value = msgDisplayName;
      if (orig_mav_msg_id) orig_mav_msg_id.value = msgIdStr;
      
      // sysid, compid, seq 填充逻辑已删除

      // 4. 关键位置数据 - 优先使用 meta.position (后端提取)
      // 如果 meta 中没有，再尝试从 application.fields 中找
      
      const xVal = (payload.x !== undefined) ? payload.x
        : (fields.x !== undefined ? fields.x
        : app.x);
      const yVal = (payload.y !== undefined) ? payload.y
        : (fields.y !== undefined ? fields.y
        : app.y);
      const zVal = (payload.z !== undefined) ? payload.z
        : (fields.z !== undefined ? fields.z
        : app.z);

      if (orig_mav_edit_x) orig_mav_edit_x.value = xVal !== undefined ? xVal : "";
      if (orig_mav_edit_y) orig_mav_edit_y.value = yVal !== undefined ? yVal : "";
      if (orig_mav_edit_z) orig_mav_edit_z.value = zVal !== undefined ? zVal : "";

      // 5. 速度数据 - 只使用 application 中的字段
      const vxVal = (payload.vx !== undefined) ? payload.vx
        : (fields.vx !== undefined ? fields.vx
        : app.vx);
      const vyVal = (payload.vy !== undefined) ? payload.vy
        : (fields.vy !== undefined ? fields.vy
        : app.vy);
      const vzVal = (payload.vz !== undefined) ? payload.vz
        : (fields.vz !== undefined ? fields.vz
        : app.vz);

      if (orig_mav_edit_vx) orig_mav_edit_vx.value = vxVal !== undefined ? vxVal : "";
      if (orig_mav_edit_vy) orig_mav_edit_vy.value = vyVal !== undefined ? vyVal : "";
      if (orig_mav_edit_vz) orig_mav_edit_vz.value = vzVal !== undefined ? vzVal : "";

      // 6. 填充原始数据区
      const rawHexVal = app.raw_hex || app.hex || "";
      if (orig_mav_raw_hex) orig_mav_raw_hex.value = rawHexVal;
      if (orig_mav_fields) {
        // 显示完整的 packet 对象，方便调试 meta 和 application 结构
        orig_mav_fields.value = JSON.stringify(packet, null, 2); 
      }
      if (mav_payload_hex) mav_payload_hex.value = rawHexVal;
      if (mav_edit_fields) mav_edit_fields.value = orig_mav_fields?.value || JSON.stringify(packet, null, 2);

      // 同步填充到右侧编辑区 (方便用户直接修改)
      if (mav_edit_x) mav_edit_x.value = orig_mav_edit_x.value;
      if (mav_edit_y) mav_edit_y.value = orig_mav_edit_y.value;
      if (mav_edit_z) mav_edit_z.value = orig_mav_edit_z.value;
      if (mav_edit_vx) mav_edit_vx.value = orig_mav_edit_vx.value;
      if (mav_edit_vy) mav_edit_vy.value = orig_mav_edit_vy.value;
      if (mav_edit_vz) mav_edit_vz.value = orig_mav_edit_vz.value;
      
      if (editMsgName) editMsgName.value = msgNameRaw || "";
      if (editMsgId) editMsgId.value = msgIdStr;
    }

    // ========== WebSocket 连接 ==========

    function connectWS() {
      try {
        const wsProtocol = (location.protocol === "https:") ? "wss:" : "ws:";
        const wsUrl = `${wsProtocol}//${location.host}/ws/parse`;
        ws = new WebSocket(wsUrl);
      } catch (e) {
        appendLog("创建 WebSocket 失败: " + e);
        setWsStatus("WebSocket: 创建失败", false);
        return;
      }

      ws.onopen = () => {
        setWsStatus("WebSocket: 已连接 (Waiting for Position Change...)", true);
        appendLog("WebSocket 已连接，后端仅在位置变更时推送数据");
      };

      ws.onclose = () => {
        setWsStatus("WebSocket: 已断开，尝试重连...", false);
        appendLog("WebSocket 已断开，3 秒后重连");
        setTimeout(connectWS, 3000);
      };

      ws.onerror = (e) => {
        console.error(e);
        setWsStatus("WebSocket: 出错", false);
        appendLog("WebSocket 出错");
      };

      ws.onmessage = (event) => {
        let data;
        try {
          data = JSON.parse(event.data);
        } catch (e) {
          appendLog("收到非 JSON 消息: " + event.data);
          return;
        }

        if (data.type !== "packet") {
          oldPacketCounter += 1;
          updateOldPacketCount();
          appendLog(`收到旧包（连续 ${oldPacketCounter} 次）: ${data.type || "(无 type)"}`);
          return;
        }
        oldPacketCounter = 0;
        updateOldPacketCount();

        const packet = data.packet || {};
        const app    = packet.application || {};
        const appProto = app.protocol || "";

        updateTimestampNow();
        addPacketRowSimple(packet, appProto);

        if (appProto === "MAVLink") {
          showMavlinkView(packet);
        } else {
          showTraditionalView();
          fillTraditionalFromPacket(packet);
        }
      };
    }

    // 绑定按钮事件（这里只是示例，并未实现真实的发送逻辑）
    document.getElementById('btn-clear-log').onclick = () => {
        logBody.innerHTML = "";
    };

    connectWS();
  </script>
</body>
</html>
