<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>数据包解析与编辑器</title>
  <style>
    :root { color-scheme: dark; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #050607;
      color: #f5f5f5;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px 0;
    }
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 16px;
      gap: 12px;
    }
    .status-pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #222;
    }
    .status-pill.ok { color: #4ade80; }
    .status-pill.err { color: #f97373; }

    .layout-two {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    .card {
      background: #111827;
      border-radius: 12px;
      padding: 12px 14px 14px;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }
    .card h2 {
      font-size: 15px;
      margin: 0 0 8px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .card h3 {
      font-size: 13px;
      margin: 10px 0 4px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .section-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .field label {
      font-size: 11px;
      color: #9ca3af;
    }
    .field input,
    .field select,
    .field textarea {
      background: #020617;
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 5px 8px;
      font-size: 12px;
      color: #e5e7eb;
      outline: none;
    }
    .field textarea {
      min-height: 70px;
      resize: vertical;
      font-family: Consolas, monospace;
    }
    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59,130,246,0.5);
    }
    .field input[readonly],
    .field textarea[readonly],
    .field input[disabled],
    .field textarea[disabled] {
      opacity: 0.9;
      cursor: default;
      background: #020617;
      border-color: #1f2937;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      padding: 0 6px;
      border-radius: 999px;
      font-size: 10px;
      background: #1f2937;
      color: #9ca3af;
      gap: 4px;
    }
    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }
    .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 10px;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #1f2937;
      color: #e5e7eb;
    }
    button.primary { background: #2563eb; }
    button.primary:hover { background: #1d4ed8; }
    button:hover { filter: brightness(1.1); }
    button:disabled { opacity: .4; cursor: default; }

    .mini-btn {
      padding: 2px 8px;
      font-size: 10px;
      border-radius: 999px;
      background: #1f2937;
      color: #9ca3af;
    }
    .mini-btn:hover {
      filter: brightness(1.2);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    thead { background: #030712; }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #111827;
      text-align: left;
    }
    tbody tr:nth-child(even) { background: #020617; }

    .log {
      margin-top: 10px;
      font-size: 11px;
      white-space: pre-wrap;
      background: #020617;
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 8px;
      max-height: 180px;
      overflow-y: auto;
    }
    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .pill {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #111827;
      color: #9ca3af;
    }
    .layout-bottom {
      margin-top: 8px;
    }
    @media (max-width: 960px) {
      .layout-two { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <h1>数据包解析与编辑器</h1>
  <div class="status-bar">
    <div>
      <span id="ws-status" class="status-pill">WebSocket: 连接中...</span>
      <span id="packet-count" class="status-pill">已接收数据包: 0</span>
    </div>
    <div>
      <span class="pill">当前数据包接收时间：<span id="packet-ts">-</span></span>
    </div>
  </div>

  <!-- 上：左原始，右可编辑 -->
  <div class="layout-two">
    <!-- 左：原始数据包（只读） -->
    <div class="card">
      <h2>
        原始数据包（只读）
        <span class="tag"><span class="tag-dot"></span> 后端解析结果</span>
      </h2>

      <h3>链路层（Ethernet）</h3>
      <div class="section-grid">
        <div class="field">
          <label for="orig-eth-src">源 MAC（只读）</label>
          <input id="orig-eth-src" readonly disabled />
        </div>
        <div class="field">
          <label for="orig-eth-dst">目的 MAC（只读）</label>
          <input id="orig-eth-dst" readonly disabled />
        </div>
        <div class="field">
          <label for="orig-eth-type">以太网类型 (0x..)（只读）</label>
          <input id="orig-eth-type" readonly disabled />
        </div>
      </div>

      <h3>网络层（IP）</h3>
      <div class="section-grid">
        <div class="field">
          <label for="orig-ip-src">源 IP（只读）</label>
          <input id="orig-ip-src" readonly disabled />
        </div>
        <div class="field">
          <label for="orig-ip-dst">目的 IP（只读）</label>
          <input id="orig-ip-dst" readonly disabled />
        </div>
        <div class="field">
          <label for="orig-ip-proto">协议号（只读）</label>
          <input id="orig-ip-proto" readonly disabled />
        </div>
      </div>

      <h3>传输层（TCP / UDP）</h3>
      <div class="section-grid">
        <div class="field">
          <label for="orig-l4-type">协议（只读）</label>
          <input id="orig-l4-type" readonly disabled />
        </div>
        <div class="field">
          <label for="orig-l4-sport">源端口（只读）</label>
          <input id="orig-l4-sport" readonly disabled />
        </div>
        <div class="field">
          <label for="orig-l4-dport">目的端口（只读）</label>
          <input id="orig-l4-dport" readonly disabled />
        </div>
      </div>

      <h3>应用层载荷</h3>
      <div class="field">
        <label for="orig-payload-hex">载荷 HEX（只读）</label>
        <textarea id="orig-payload-hex" readonly disabled></textarea>
      </div>
      <div class="field">
        <label for="orig-payload-text">载荷文本（UTF-8，只读）</label>
        <textarea id="orig-payload-text" readonly disabled></textarea>
      </div>
    </div>

    <!-- 右：编辑数据包 -->
    <div class="card">
      <h2>
        编辑数据包（可篡改）
        <span class="tag"><span class="tag-dot"></span> 当前数据包可修改</span>
      </h2>

      <h3>
        链路层（Ethernet）
        <button id="btn-copy-eth" class="mini-btn" type="button">拷贝链路层</button>
      </h3>
      <div class="section-grid">
        <div class="field">
          <label for="eth-src">源 MAC</label>
          <input id="eth-src" />
        </div>
        <div class="field">
          <label for="eth-dst">目的 MAC</label>
          <input id="eth-dst" />
        </div>
        <div class="field">
          <label for="eth-type">以太网类型 (0x..)</label>
          <input id="eth-type" />
        </div>
      </div>

      <h3>
        网络层（IP）
        <button id="btn-copy-ip" class="mini-btn" type="button">拷贝网络层</button>
      </h3>
      <div class="section-grid">
        <div class="field">
          <label for="ip-src">源 IP</label>
          <input id="ip-src" />
        </div>
        <div class="field">
          <label for="ip-dst">目的 IP</label>
          <input id="ip-dst" />
        </div>
        <div class="field">
          <label for="ip-proto">协议号</label>
          <input id="ip-proto" />
        </div>
      </div>

      <h3>
        传输层（TCP / UDP）
        <button id="btn-copy-l4" class="mini-btn" type="button">拷贝传输层</button>
      </h3>
      <div class="section-grid">
        <div class="field">
          <label for="l4-type">协议</label>
          <select id="l4-type">
            <option value="auto">自动（按解析结果）</option>
            <option value="TCP">TCP</option>
            <option value="UDP">UDP</option>
          </select>
        </div>
        <div class="field">
          <label for="l4-sport">源端口</label>
          <input id="l4-sport" />
        </div>
        <div class="field">
          <label for="l4-dport">目的端口</label>
          <input id="l4-dport" />
        </div>
      </div>

      <h3>
        应用层载荷
        <button id="btn-copy-payload" class="mini-btn" type="button">拷贝载荷</button>
      </h3>
      <div class="section-grid">
        <div class="field">
          <label for="payload-hex">编辑载荷 HEX</label>
          <textarea id="payload-hex"></textarea>
        </div>
        <div class="field">
          <label for="payload-text">编辑载荷文本（UTF-8）</label>
          <textarea id="payload-text"></textarea>
        </div>
      </div>

      <h3>发送配置</h3>
      <div class="section-grid">
        <div class="field">
          <label for="target-ip">目标 IP（输入或选择）</label>
          <input id="target-ip" list="target-ip-list" placeholder="例如：192.168.1.100" />
          <datalist id="target-ip-list">
            <option value="192.168.0.10"></option>
            <option value="192.168.0.20"></option>
            <option value="10.0.0.5"></option>
          </datalist>
        </div>
        <div class="field">
          <label for="packet-id">数据包 ID（可选，用于匹配原始包）</label>
          <input id="packet-id" placeholder="由后端分配的唯一 ID" />
        </div>
      </div>

      <div class="actions">
        <button id="btn-copy-all" type="button">拷贝全部层</button>
        <button id="btn-send" class="primary" type="button">重新封装并发送</button>
      </div>
    </div>
  </div>

  <!-- 下：帧列表 + 日志 -->
  <div class="card layout-bottom">
    <h2>最近链路层帧 & 日志</h2>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>时间</th>
          <th>Src MAC</th>
          <th>Dst MAC</th>
          <th>Type</th>
        </tr>
      </thead>
      <tbody id="eth-table-body">
        <!-- 动态添加 -->
      </tbody>
    </table>

    <div class="log">
      <div class="log-header">
        <span>日志</span>
        <button id="btn-clear-log" style="font-size:10px;padding:2px 8px;">清空日志</button>
      </div>
      <div id="log-body"></div>
    </div>
  </div>

  <script>
    let ws;
    let packetCounter = 0;
    let latestPacket = null;

    const wsStatusEl    = document.getElementById("ws-status");
    const packetCountEl = document.getElementById("packet-count");
    const packetTsEl    = document.getElementById("packet-ts");
    const ethTableBody  = document.getElementById("eth-table-body");
    const logBody       = document.getElementById("log-body");

    // 原始表单
    const origEthSrcInput  = document.getElementById("orig-eth-src");
    const origEthDstInput  = document.getElementById("orig-eth-dst");
    const origEthTypeInput = document.getElementById("orig-eth-type");

    const origIpSrcInput   = document.getElementById("orig-ip-src");
    const origIpDstInput   = document.getElementById("orig-ip-dst");
    const origIpProtoInput = document.getElementById("orig-ip-proto");

    const origL4TypeInput  = document.getElementById("orig-l4-type");
    const origL4SportInput = document.getElementById("orig-l4-sport");
    const origL4DportInput = document.getElementById("orig-l4-dport");

    const origPayloadHexTextarea  = document.getElementById("orig-payload-hex");
    const origPayloadTextTextarea = document.getElementById("orig-payload-text");

    // 编辑表单
    const ethSrcInput  = document.getElementById("eth-src");
    const ethDstInput  = document.getElementById("eth-dst");
    const ethTypeInput = document.getElementById("eth-type");

    const ipSrcInput   = document.getElementById("ip-src");
    const ipDstInput   = document.getElementById("ip-dst");
    const ipProtoInput = document.getElementById("ip-proto");

    const l4TypeSelect = document.getElementById("l4-type");
    const l4SportInput = document.getElementById("l4-sport");
    const l4DportInput = document.getElementById("l4-dport");

    const payloadHexTextarea  = document.getElementById("payload-hex");
    const payloadTextTextarea = document.getElementById("payload-text");

    const targetIpInput = document.getElementById("target-ip");
    const packetIdInput = document.getElementById("packet-id");

    const btnSend       = document.getElementById("btn-send");
    const btnCopyEth    = document.getElementById("btn-copy-eth");
    const btnCopyIp     = document.getElementById("btn-copy-ip");
    const btnCopyL4     = document.getElementById("btn-copy-l4");
    const btnCopyPayload= document.getElementById("btn-copy-payload");
    const btnCopyAll    = document.getElementById("btn-copy-all");
    const btnClearLog   = document.getElementById("btn-clear-log");

    function appendLog(text) {
      const time = new Date().toISOString().split("T")[1].split(".")[0];
      const line = document.createElement("div");
      line.textContent = `[${time}] ${text}`;
      logBody.appendChild(line);
      logBody.parentElement.scrollTop = logBody.parentElement.scrollHeight;
    }

    function setWsStatus(text, ok = false) {
      wsStatusEl.textContent = text;
      wsStatusEl.classList.toggle("ok", ok);
      wsStatusEl.classList.toggle("err", !ok);
    }

    function updatePacketCount() {
      packetCountEl.textContent = `已接收数据包: ${packetCounter}`;
    }

    function updateTimestamp(tsIso) {
      if (!tsIso) {
        packetTsEl.textContent = "-";
        return;
      }
      try {
        const d = new Date(tsIso);
        if (isNaN(d.getTime())) throw new Error();
        packetTsEl.textContent = d.toLocaleTimeString();
      } catch {
        packetTsEl.textContent = tsIso;
      }
    }

    function hexToText(hex) {
      if (!hex) return "";
      const clean = hex.replace(/\s+/g, "");
      if (clean.length % 2 !== 0) return "";
      const bytes = [];
      for (let i = 0; i < clean.length; i += 2) {
        const b = parseInt(clean.slice(i, i + 2), 16);
        if (Number.isNaN(b)) return "";
        bytes.push(b);
      }
      try {
        return new TextDecoder("utf-8").decode(new Uint8Array(bytes));
      } catch {
        return "";
      }
    }

    function textToHex(text) {
      if (!text) return "";
      const encoder = new TextEncoder();
      const bytes = encoder.encode(text);
      return Array.from(bytes).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    function fillOriginalForm(packet) {
      const result = packet.result || {};
      const layers = result.layers || [];

      const eth = layers.find(l => l.layer === "Ethernet") || {};
      const ip  = layers.find(l => l.layer === "IP" || l.layer === "IPv6") || {};
      const tcp = layers.find(l => l.layer === "TCP") || {};
      const udp = layers.find(l => l.layer === "UDP") || {};

      origEthSrcInput.value  = eth.src || "";
      origEthDstInput.value  = eth.dst || "";
      origEthTypeInput.value = eth.type || "";

      origIpSrcInput.value   = ip.src || "";
      origIpDstInput.value   = ip.dst || "";
      origIpProtoInput.value = (ip.proto !== undefined && ip.proto !== null) ? String(ip.proto) : "";

      let l4Type = "";
      if (tcp.layer === "TCP") l4Type = "TCP";
      if (udp.layer === "UDP") l4Type = "UDP";

      origL4TypeInput.value  = l4Type;
      origL4SportInput.value = tcp.sport || udp.sport || "";
      origL4DportInput.value = tcp.dport || udp.dport || "";

      const payloadHex = result.payload_raw_hex || "";
      origPayloadHexTextarea.value  = payloadHex;
      origPayloadTextTextarea.value = hexToText(payloadHex);
    }

    // 各层拷贝
    function copyEthLayer() {
      ethSrcInput.value  = origEthSrcInput.value;
      ethDstInput.value  = origEthDstInput.value;
      ethTypeInput.value = origEthTypeInput.value;
    }
    function copyIpLayer() {
      ipSrcInput.value   = origIpSrcInput.value;
      ipDstInput.value   = origIpDstInput.value;
      ipProtoInput.value = origIpProtoInput.value;
    }
    function copyL4Layer() {
      l4TypeSelect.value = origL4TypeInput.value || "auto";
      l4SportInput.value = origL4SportInput.value;
      l4DportInput.value = origL4DportInput.value;
    }
    function copyPayloadLayer() {
      payloadHexTextarea.value  = origPayloadHexTextarea.value;
      payloadTextTextarea.value = origPayloadTextTextarea.value;
    }

    function copyAllLayers() {
      copyEthLayer();
      copyIpLayer();
      copyL4Layer();
      copyPayloadLayer();
      appendLog("已将所有层从左侧拷贝到右侧表单");
    }

    function addEthernetRow(packet) {
      const result = packet.result || {};
      const layers = result.layers || [];
      const eth = layers.find(l => l.layer === "Ethernet") || {};

      const tr = document.createElement("tr");
      const ts = packet.received_at ? new Date(packet.received_at) : new Date();
      const tsStr = ts.toLocaleTimeString();

      const cols = [
        ++packetCounter,
        tsStr,
        eth.src || "",
        eth.dst || "",
        eth.type || "",
      ];

      cols.forEach(v => {
        const td = document.createElement("td");
        td.textContent = v;
        tr.appendChild(td);
      });

      ethTableBody.insertBefore(tr, ethTableBody.firstChild);
      updatePacketCount();
    }

    function connectWS() {
      try {
        ws = new WebSocket("ws://localhost:8000/ws/parse");
      } catch (e) {
        appendLog("创建 WebSocket 失败: " + e);
        setWsStatus("WebSocket: 创建失败", false);
        return;
      }

      ws.onopen = () => {
        setWsStatus("WebSocket: 已连接，等待后端推送数据包...", true);
        appendLog("WebSocket 已连接");
        btnSend.disabled    = false;
        btnCopyEth.disabled = false;
        btnCopyIp.disabled  = false;
        btnCopyL4.disabled  = false;
        btnCopyPayload.disabled = false;
        btnCopyAll.disabled = false;
      };

      ws.onclose = () => {
        setWsStatus("WebSocket: 已断开，尝试重连...", false);
        appendLog("WebSocket 已断开，3 秒后重连");
        btnSend.disabled    = true;
        btnCopyEth.disabled = true;
        btnCopyIp.disabled  = true;
        btnCopyL4.disabled  = true;
        btnCopyPayload.disabled = true;
        btnCopyAll.disabled = true;
        setTimeout(connectWS, 3000);
      };

      ws.onerror = (e) => {
        console.error(e);
        setWsStatus("WebSocket: 出错", false);
        appendLog("WebSocket 出错");
      };

      ws.onmessage = (event) => {
        let data;
        try {
          data = JSON.parse(event.data);
        } catch (e) {
          appendLog("收到非 JSON 消息: " + event.data);
          return;
        }

        if (data.type === "net_result") {
          latestPacket = data;
          addEthernetRow(data);
          fillOriginalForm(data);  // 只更新左边
          const ts = data.received_at || new Date().toISOString();
          updateTimestamp(ts);
          packetIdInput.value = data.packet_id || "";
          appendLog("收到 net_result 数据包");
        } else {
          appendLog("收到其他类型消息: " + (data.type || "(无 type)"));
        }
      };
    }

    function buildModifiedPacketPayload() {
      if (!latestPacket) {
        alert("当前没有可以编辑的数据包");
        return null;
      }

      const ethernet = {
        layer: "Ethernet",
        src: ethSrcInput.value.trim(),
        dst: ethDstInput.value.trim(),
        type: ethTypeInput.value.trim(),
      };

      const ip = {
        layer: "IP",
        src: ipSrcInput.value.trim(),
        dst: ipDstInput.value.trim(),
        proto: ipProtoInput.value.trim() ? Number(ipProtoInput.value.trim()) : undefined,
      };

      const l4Type = l4TypeSelect.value === "auto" ? null : l4TypeSelect.value;
      const transport = {
        layer: l4Type || undefined,
        sport: l4SportInput.value.trim() ? Number(l4SportInput.value.trim()) : undefined,
        dport: l4DportInput.value.trim() ? Number(l4DportInput.value.trim()) : undefined,
      };

      const payloadHex = payloadHexTextarea.value.replace(/\s+/g, "");
      const targetIp = targetIpInput.value.trim();

      return {
        action: "modify_and_send",
        original_packet_id: latestPacket.packet_id || null,
        target_ip: targetIp || null,
        layers: { ethernet, ip, transport },
        payload_hex: payloadHex,
      };
    }

    // HEX <-> 文本 双向联动（右侧编辑区）
    let updatingFromHex = false;
    let updatingFromText = false;

    payloadHexTextarea.addEventListener("input", () => {
      if (updatingFromText) return;
      updatingFromHex = true;
      const hex = payloadHexTextarea.value.replace(/\s+/g, "");
      payloadTextTextarea.value = hexToText(hex);
      updatingFromHex = false;
    });

    payloadTextTextarea.addEventListener("input", () => {
      if (updatingFromHex) return;
      updatingFromText = true;
      const text = payloadTextTextarea.value;
      payloadHexTextarea.value = textToHex(text);
      updatingFromText = false;
    });

    // 按钮事件
    btnCopyEth.addEventListener("click", () => {
      if (!latestPacket) { alert("还没有收到任何数据包"); return; }
      copyEthLayer();
    });
    btnCopyIp.addEventListener("click", () => {
      if (!latestPacket) { alert("还没有收到任何数据包"); return; }
      copyIpLayer();
    });
    btnCopyL4.addEventListener("click", () => {
      if (!latestPacket) { alert("还没有收到任何数据包"); return; }
      copyL4Layer();
    });
    btnCopyPayload.addEventListener("click", () => {
      if (!latestPacket) { alert("还没有收到任何数据包"); return; }
      copyPayloadLayer();
    });
    btnCopyAll.addEventListener("click", () => {
      if (!latestPacket) { alert("还没有收到任何数据包"); return; }
      copyAllLayers();
    });

    btnSend.addEventListener("click", () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert("WebSocket 未连接");
        return;
      }
      const payload = buildModifiedPacketPayload();
      if (!payload) return;
      ws.send(JSON.stringify(payload));
      appendLog("发送 modify_and_send 请求: " + JSON.stringify(payload));
    });

    btnClearLog.addEventListener("click", () => {
      logBody.innerHTML = "";
    });

    connectWS();
  </script>
</body>
</html>
